#!/bin/bash

set -e
set -u

# Ask for password upfront
sudo -v

#########################
##### OS Configs ########
#########################

ask_yes_or_no () {
    read -p "$1 ([y]es or [N]o - Default no)"
    case $(echo $REPLY | tr '[A-Z]' '[a-z]') in
        y|yes) echo "yes" ;;
        *)     echo "no" ;;
    esac
}

# Use touch-id instead of typing the root password
enable_touch_id_sudo () {
    if [ $EUID -ne 0 ]; then
        echo "Must be root"
        exit
    fi
    chmod 644 /etc/pam.d/sudo
    grep -qxF 'auth sufficient pam_tid.so' /etc/pam.d/sudo || printf '%s\n%s\n' "auth sufficient pam_tid.so" "$(cat /etc/pam.d/sudo)" > /etc/pam.d/sudo
    chmod 444 /etc/pam.d/sudo
}

if [[ "yes" == $(ask_yes_or_no "Use touch-id as sudo?") ]]; then
    sudo su root -c "$(declare -f enable_touch_id_sudo); enable_touch_id_sudo"
fi

# Update hostname
if [[ "yes" == $(ask_yes_or_no "Update hostname?") ]]; then
    sudo scutil --set HostName entropy      # Primary hostname
    sudo scutil --set LocalHostName entropy # Bonjour hostname
    sudo scutil --set ComputerName entropy  # Computer name
    # Flush Cache
    dscacheutil -flushcache
fi


#########################
##### HomeBrew ##########
#########################

which -s brew >/dev/null
if [[ "$?" != 0 ]] ; then
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
fi

cp Brewfile ~/Brewfile
brew bundle install
pyenv install 3.8.5

# Visual Code - Extensions
code --install-extension dotiful.dotfiles-syntax-highlighting
code --install-extension redhat.vscode-yaml
code --install-extension vscode.vim
code --install-extension eamodio.gitlens
code --install-extension donjayamanne.githistory
code --install-extension shardulm94.trailing-spaces
code --install-extension ms-python.python
code --install-extension shakram02.bash-beautify
code --install-extension puppet.puppet-vscode
code --install-extension hashicorp.terraform
code --install-extension shyykosherhiy.vscode-spotify


#########################
##### Defaults ##########
#########################

####### Global ##########

# Enable Dark Mode - Requires log out
defaults write "Apple Global Domain" AppleInterfaceStyle -string "Dark"

# Finder: Show File Name extensions
defaults write NSGlobalDomain AppleShowAllExtensions -bool true

# Auto hide menu bar
defaults write "Apple Global Domain" _HIHideMenuBar -bool true

####### Finder ##########

# Finder: Show File Name extensions
defaults write com.apple.finder AppleShowAllFiles -bool true

# Search on the current folder by default
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

##### Trackpad ##########

# Secondary Click on right corner - Requires log out
defaults write "Apple Global Domain"  ContextMenuGesture -integer 1
defaults write com.apple.AppleMultitouchTrackpad TrackpadRightClick -bool false
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool false
defaults write com.apple.AppleMultitouchTrackpad TrackpadCornerSecondaryClick -integer 2
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -integer 2

# Silent clicking
defaults write com.apple.AppleMultitouchTrackpad ActuationStrength -bool false

##### Dock ##########

# Autohide
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock autohide-delay -float 0

# Minimize effect
defaults write com.apple.dock mineffect -string scale

# Size
defaults write com.apple.dock tilesize -int 32

# Minimize windows into their application’s icon
defaults write com.apple.dock minimize-to-application -bool true

# Don’t animate opening applications
defaults write com.apple.dock launchanim -bool false

# Top right screen corner -> Notification Center
defaults write com.apple.dock wvous-tr-corner -int 12
defaults write com.apple.dock wvous-tr-modifier -int 0


# Add Applications to Dock

# Usage: add_user_app_to_dock Spotify
add_user_app_to_dock () {
    defaults read com.apple.dock | grep -qi "$1"
    if [[ "$?" != 0 ]]; then
        defaults write com.apple.dock persistent-apps -array-add '<dict><key>tile-data</key><dict><key>file-data</key><dict><key>_CFURLString</key><string>/Applications/'"$1"'.app</string><key>_CFURLStringType</key><integer>0</integer></dict></dict></dict>'
    fi
}

# Usage: add_system_app_to_dock Calendar
add_system_app_to_dock () {
    defaults read com.apple.dock | grep -qi "$1"
    if [[ "$?" != 0 ]]; then
        defaults write com.apple.dock persistent-apps -array-add '<dict><key>tile-data</key><dict><key>file-data</key><dict><key>_CFURLString</key><string>/System/Applications/'"$1"'.app</string><key>_CFURLStringType</key><integer>0</integer></dict></dict></dict>'
    fi
}

add_system_app_to_dock Calendar
add_system_app_to_dock Mail
add_system_app_to_dock Safari
add_user_app_to_dock iTerm
add_user_app_to_dock Spotify
add_user_app_to_dock Visual\ Studio\ Code
add_user_app_to_dock Slack
add_user_app_to_dock Whatsapp

killall Dock

####### Menu Bar ########

# Clock
defaults write com.apple.menuextra.clock DateFormat "EEE MMM d h:mm a"
defaults write com.apple.menuextra.clock isAnalog -bool false

killall SystemUIServer

